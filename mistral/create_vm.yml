---
version: '2.0'

create_vm:
  description: Simple workflow example
  type: direct

  input:
    - vm_name
    - image_ref
    - flavor_ref
    - net_id
  output:
    vm_id: <% $.vm_id %>

  tasks:
    create_server:
      action: nova.servers_create name=<% $.vm_name %> image=<% $.image_ref %> flavor=<% $.flavor_ref %> nic=net-id=<% $.net_id %>
      publish:
        vm_id: <% task(create_server).result.id %>
        ssh_password: cubswin:)
        ssh_username: cirros
      on-success:
        - wait_vm_active

    wait_vm_active:
      action: nova.servers_find id=<% $.vm_id %> status='ACTIVE'
      retry:
        delay: 5
        count: 15
      on-success:
        - search_for_ip

    search_for_ip:
      action: nova.servers_find id=<% $.vm_id %>
      publish:
        vm_ip: <% task(search_for_ip).result.addresses.private[0].addr %>
      on-success:
        - wait_vm_ssh

    wait_vm_ssh:
      description: Wait till operating system on the VM is up (SSH command).
      action: std.wait_ssh username=<% $.ssh_username %> password=<% $.ssh_password %> host=<% $.vm_ip %>
      retry:
        count: 10
        delay: 10
      on-success:
        - ping_home

    ping_home:
      action: std.ssh cmd="ping -c 10 192.168.0.2" host=<% $.vm_ip %> username=<% $.ssh_username %> password=<% $.ssh_password %>
